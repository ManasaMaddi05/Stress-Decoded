<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Heart Rate Monitor</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --glow-green: #5cff5c;
      --dark-bg: #000000;
      --panel-bg: rgba(0, 20, 0, 0.7);
      --low-hr: #2563eb;
      --resting-hr: #22c55e;
      --moderate-hr: #eab308;
      --high-hr: #dc2626;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'JetBrains Mono', monospace;
      background-color: var(--dark-bg);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .student-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--glow-green);
      text-shadow: 0 0 10px rgba(92, 255, 92, 0.7),
                   0 0 20px rgba(92, 255, 92, 0.5);
      margin: 0;
      padding: 0.5rem 0;
    }
    
    .main-content {
      display: flex;
      gap: 2rem;
      flex: 1;
    }
    
    .heart-rate-display {
      flex: 0 0 300px;
      background: var(--panel-bg);
      border: 1px solid var(--glow-green);
      border-radius: 8px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(92, 255, 92, 0.3);
    }
    
    .hr-label {
      font-size: 1.5rem;
      color: var(--glow-green);
      margin-bottom: 0.5rem;
    }
    
    .bpm-label {
      font-size: 1rem;
      color: var(--glow-green);
      margin-bottom: 2rem;
    }
    
    .hr-value {
      font-size: 8rem;
      font-weight: 700;
      color: var(--glow-green);
      text-shadow: 0 0 10px rgba(92, 255, 92, 0.7),
                   0 0 20px rgba(92, 255, 92, 0.5);
      line-height: 1;
      margin-bottom: 2rem;
    }
    
    .hr-subtitle {
      font-size: 1rem;
      color: var(--glow-green);
      text-align: center;
      font-weight: 600;
      max-width: 200px;
    }
    
    .chart-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .chart-header {
      color: var(--glow-green);
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    
    .chart {
      background: var(--panel-bg);
      border: 1px solid var(--glow-green);
      border-radius: 8px;
      flex: 1;
      padding: 1rem;
      box-shadow: 0 0 15px rgba(92, 255, 92, 0.3);
      position: relative;
    }
    
    .controls {
      margin-top: 1.5rem;
    }
    
    .slider-container {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }
    
    .slider-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .progress-label {
      color: var(--glow-green);
      font-weight: 600;
    }
    
    .time-label {
      color: var(--glow-green);
      font-weight: 600;
    }
    
    .slider-track {
      position: relative;
      height: 30px;
      background: var(--panel-bg);
      border: 1px solid var(--glow-green);
      border-radius: 15px;
      overflow: hidden;
    }
    
    .slider-progress {
      position: absolute;
      height: 100%;
      background: rgba(92, 255, 92, 0.2);
      border-right: 2px solid var(--glow-green);
      box-shadow: 0 0 10px rgba(92, 255, 92, 0.5);
    }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 30px;
      background: transparent;
      outline: none;
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      z-index: 10;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 30px;
      background: var(--glow-green);
      cursor: pointer;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(92, 255, 92, 0.7);
    }
    
    .slider::-moz-range-thumb {
      width: 20px;
      height: 30px;
      background: var(--glow-green);
      cursor: pointer;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(92, 255, 92, 0.7);
    }
    
    .slider-caption {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    
    .legend {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    
    .legend-label {
      font-size: 0.875rem;
      color: white;
    }
    
    .low-color {
      background-color: var(--low-hr);
    }
    
    .resting-color {
      background-color: var(--resting-hr);
    }
    
    .moderate-color {
      background-color: var(--moderate-hr);
    }
    
    .high-color {
      background-color: var(--high-hr);
    }
    
    .axis-label {
      fill: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }
    
    .grid line {
      stroke: rgba(255, 255, 255, 0.1);
    }
    
    .domain, .tick line {
      stroke: rgba(255, 255, 255, 0.3);
    }
    
    .tick text {
      fill: rgba(255, 255, 255, 0.7);
    }
    
    .hr-line {
      fill: none;
      stroke-width: 2.5;
    }
    
    .hr-area {
      opacity: 0.2;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      
      .heart-rate-display {
        flex: 0 0 auto;
      }
      
      .hr-value {
        font-size: 6rem;
      }
    }
    
    /* Add styles for the student dropdown */
    .student-selector {
      margin-top: 1rem;
      text-align: center;
    }
    
    .student-dropdown {
      background: var(--panel-bg);
      color: var(--glow-green);
      border: 1px solid var(--glow-green);
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(92, 255, 92, 0.3);
      outline: none;
    }
    
    .student-dropdown:focus {
      box-shadow: 0 0 15px rgba(92, 255, 92, 0.5);
    }
    
    .student-dropdown option {
      background-color: #001400;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="student-title" id="student-title">Student #3</h1>
      <div class="student-selector">
        <select id="student-dropdown" class="student-dropdown">
          <option value="1">Student #1</option>
          <option value="2">Student #2</option>
          <option value="3" selected>Student #3</option>
          <option value="4">Student #4</option>
          <option value="5">Student #5</option>
          <option value="6">Student #6</option>
          <option value="7">Student #7</option>
          <option value="8">Student #8</option>
          <option value="9">Student #9</option>
          <option value="10">Student #10</option>
        </select>
        <select id="exam-dropdown" class="student-dropdown" style="margin-left: 10px;">
          <option value="midterm1" selected>Midterm 1</option>
          <option value="midterm2">Midterm 2</option>
          <option value="final">Final</option>
        </select>
      </div>
    </div>
    
    <div class="main-content">
      <div class="heart-rate-display">
        <div class="hr-label">HR</div>
        <div class="bpm-label">bpm</div>
        <div class="hr-value" id="hr-value">80</div>
        <div class="hr-subtitle">Heart Rate at Selected Time</div>
      </div>
      
      <div class="chart-container">
        <div class="chart-header">Heart Rate Over the Course of the Exam</div>
        <div class="chart" id="heart-rate-chart"></div>
        
        <div class="controls">
          <div class="slider-container">
            <div class="slider-header">
              <div class="progress-label" id="progress-label">0% through the exam</div>
              <div class="time-label" id="time-label">00:00:00</div>
            </div>
            <div class="slider-track">
              <div class="slider-progress" id="slider-progress" style="width: 0%"></div>
              <input type="range" min="0" max="100" value="0" class="slider" id="time-slider">
            </div>
            <div class="slider-caption">Move the slider to explore heart rate changes during the exam</div>
          </div>
          
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color low-color"></div>
              <div class="legend-label">Low</div>
            </div>
            <div class="legend-item">
              <div class="legend-color resting-color"></div>
              <div class="legend-label">Resting</div>
            </div>
            <div class="legend-item">
              <div class="legend-color moderate-color"></div>
              <div class="legend-label">Moderate</div>
            </div>
            <div class="legend-item">
              <div class="legend-color high-color"></div>
              <div class="legend-label">High</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration
      const config = {
        studentId: 3, // Default student ID
        examType: 'midterm1', // Default exam type
        examDurations: {
          midterm1: 5400, // 1.5 hour for midterm1
          midterm2: 5400, // 1.5 hour for midterm2
          final: 10800    // 3 hours for final
        },
        heartRateZones: {
          low: { min: 40, max: 60, color: '#2563eb' },
          resting: { min: 60, max: 80, color: '#22c55e' },
          moderate: { min: 80, max: 100, color: '#eab308' },
          high: { min: 100, max: 160, color: '#dc2626' }
        },
        dataPath: './Data/' // Path to data files
      };
      
      // Update config based on URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('student')) {
        config.studentId = parseInt(urlParams.get('student'));
        document.getElementById('student-dropdown').value = config.studentId;
      }
      if (urlParams.has('exam')) {
        config.examType = urlParams.get('exam');
        document.getElementById('exam-dropdown').value = config.examType;
      }
      
      // Update student title
      document.getElementById('student-title').textContent = `Student #${config.studentId}`;
      
      // Function to load heart rate data from CSV
      async function loadHeartRateData(studentId, examType) {
        try {
          // Map of possible file naming patterns for each exam type
          const filePatterns = {
            midterm1: [
              'Midterm 1_HR.csv'
            ],
            midterm2: [
              'Midterm 2_HR.csv'
            ],
            final: [
              'Final_HR.csv'
            ]
          };
          
          // Try each possible file pattern for the selected exam
          let csvText = null;
          let loadedPath = '';
          
          for (const pattern of filePatterns[examType]) {
            const path = `${config.dataPath}${pattern}`;
            try {
              console.log(`Trying to load from ${path}...`);
              const response = await fetch(path);
              if (response.ok) {
                csvText = await response.text();
                loadedPath = path;
                console.log(`Successfully loaded data from ${path}`);
                break;
              }
            } catch (e) {
              console.warn(`Failed to load from ${path}`);
            }
          }
          
          if (!csvText) {
            throw new Error(`Data file for ${examType} not found in any of the expected locations`);
          }
          
          const rows = csvText.trim().split('\n');
          const headers = rows[0].split(',');
          
          console.log("CSV Headers:", headers);
          
          // Find the column index for the selected student
          // Try multiple possible column naming patterns
          const possibleColumnNames = [
            `S${studentId}_HR`,
            `S${studentId}_hr`,
            `s${studentId}_HR`,
            `s${studentId}_hr`,
            `S${studentId}`,
            `s${studentId}`,
            `Student${studentId}`,
            `student${studentId}`,
            `Student${studentId}_HR`,
            `student${studentId}_hr`
          ];
          
          let studentColumnIndex = -1;
          for (const columnName of possibleColumnNames) {
            const index = headers.findIndex(header => 
              header.trim().toLowerCase() === columnName.toLowerCase()
            );
            if (index !== -1) {
              studentColumnIndex = index;
              console.log(`Found student data in column: ${headers[index]}`);
              break;
            }
          }
          
          // If still not found, try a more flexible approach
          if (studentColumnIndex === -1) {
            studentColumnIndex = headers.findIndex(header => 
              header.trim().toLowerCase().includes(`s${studentId}`) || 
              header.trim().toLowerCase().includes(`student${studentId}`)
            );
            if (studentColumnIndex !== -1) {
              console.log(`Found student data using partial match in column: ${headers[studentColumnIndex]}`);
            }
          }
          
          if (studentColumnIndex === -1) {
            throw new Error(`Data for Student #${studentId} not found in CSV`);
          }
          
          // Parse the data for the selected student
          const data = [];
          for (let i = 1; i < rows.length; i++) {
            const values = rows[i].split(',');
            if (values.length <= studentColumnIndex) continue;
            
            // Assuming the first column is time in seconds
            const time = parseFloat(values[0]);
            const heartRate = parseFloat(values[studentColumnIndex]);
            
            if (!isNaN(time) && !isNaN(heartRate)) {
              data.push({
                time: time,
                heartRate: heartRate
              });
            }
          }
          
          if (data.length === 0) {
            throw new Error('No valid data points found');
          }
          
          console.log(`Loaded ${data.length} data points for Student #${studentId} from ${loadedPath}`);
          return data;
        } catch (error) {
          console.error('Error loading heart rate data:', error);
          alert(`Failed to load data for Student #${studentId}: ${error.message}`);
          return null;
        }
      }
      
      // Initialize the visualization
      async function initVisualization(studentId, examType) {
        // Update student title and dropdowns
        document.getElementById('student-title').textContent = `Student #${studentId} - ${examType.toUpperCase()}`;
        document.getElementById('student-dropdown').value = studentId;
        document.getElementById('exam-dropdown').value = examType;
        
        // Set exam duration based on exam type
        const examDuration = config.examDurations[examType];
        
        // Load heart rate data for the selected student and exam
        const heartRateData = await loadHeartRateData(studentId, examType);
        
        // If data loading failed, don't proceed
        if (!heartRateData) return;
        
        // Set up the chart
        const chartElement = document.getElementById('heart-rate-chart');
        const chartWidth = chartElement.clientWidth;
        const chartHeight = chartElement.clientHeight;
        const margin = { top: 20, right: 30, bottom: 40, left: 50 };
        const width = chartWidth - margin.left - margin.right;
        const height = chartHeight - margin.top - margin.bottom;
        
        // Clear any existing chart
        d3.select('#heart-rate-chart').selectAll('*').remove();
        
        // Create SVG
        const svg = d3.select('#heart-rate-chart')
          .append('svg')
          .attr('width', chartWidth)
          .attr('height', chartHeight)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);
        
        // Create scales
        const x = d3.scaleLinear()
          .domain([0, examDuration])
          .range([0, width]);
        
        // Determine y-axis domain based on actual data
        const minHR = Math.max(40, d3.min(heartRateData, d => d.heartRate) - 10);
        const maxHR = Math.min(160, d3.max(heartRateData, d => d.heartRate) + 10);
        
        const y = d3.scaleLinear()
          .domain([minHR, maxHR])
          .range([height, 0]);
        
        // Create axes
        const xAxis = d3.axisBottom(x)
          .tickFormat(d => formatTime(d))
          .ticks(6);
        
        const yAxis = d3.axisLeft(y);
        
        // Add X axis
        svg.append('g')
          .attr('transform', `translate(0,${height})`)
          .call(xAxis);
        
        // Add Y axis
        svg.append('g')
          .call(yAxis);
        
        // Add X axis label
        svg.append('text')
          .attr('class', 'axis-label')
          .attr('x', width / 2)
          .attr('y', height + margin.bottom - 5)
          .attr('text-anchor', 'middle')
          .text('Time Since Exam Started (HH:MM:SS)');
        
        // Add Y axis label
        svg.append('text')
          .attr('class', 'axis-label')
          .attr('transform', 'rotate(-90)')
          .attr('x', -height / 2)
          .attr('y', -margin.left + 15)
          .attr('text-anchor', 'middle')
          .text('Heart Rate (bpm)');
        
        // Add horizontal grid lines
        svg.append('g')
          .attr('class', 'grid')
          .call(d3.axisLeft(y)
            .tickSize(-width)
            .tickFormat('')
          );
        
        // Add zone backgrounds
        Object.entries(config.heartRateZones).forEach(([zone, { min, max, color }]) => {
          // Only show zones that are within our y-axis domain
          if (max >= minHR && min <= maxHR) {
            const zoneMin = Math.max(min, minHR);
            const zoneMax = Math.min(max, maxHR);
            
            svg.append('rect')
              .attr('x', 0)
              .attr('y', y(zoneMax))
              .attr('width', width)
              .attr('height', y(zoneMin) - y(zoneMax))
              .attr('fill', color)
              .attr('opacity', 0.1);
          }
        });
        
        // Add heart rate line
        const line = d3.line()
          .x(d => x(d.time))
          .y(d => y(d.heartRate))
          .curve(d3.curveMonotoneX);
        
        svg.append('path')
          .datum(heartRateData)
          .attr('class', 'hr-line')
          .attr('d', line)
          .attr('stroke', 'var(--glow-green)')
          .attr('stroke-width', 2.5);
        
        // Add heart rate area
        const area = d3.area()
          .x(d => x(d.time))
          .y0(height)
          .y1(d => y(d.heartRate))
          .curve(d3.curveMonotoneX);
        
        svg.append('path')
          .datum(heartRateData)
          .attr('class', 'hr-area')
          .attr('d', area)
          .attr('fill', 'var(--glow-green)');
        
        // Add vertical line indicator for current time
        const timeIndicator = svg.append('line')
          .attr('class', 'time-indicator')
          .attr('x1', 0)
          .attr('y1', 0)
          .attr('x2', 0)
          .attr('y2', height)
          .attr('stroke', 'white')
          .attr('stroke-width', 1)
          .attr('stroke-dasharray', '5,5')
          .style('opacity', 0);
        
        // Add dot indicator for current heart rate
        const dotIndicator = svg.append('circle')
          .attr('class', 'dot-indicator')
          .attr('r', 6)
          .attr('fill', 'white')
          .attr('stroke', 'var(--glow-green)')
          .attr('stroke-width', 2)
          .style('opacity', 0);
        
        // Add tooltip for heart rate value
        const tooltip = svg.append('g')
          .attr('class', 'tooltip')
          .style('opacity', 0);
        
        tooltip.append('rect')
          .attr('width', 80)
          .attr('height', 30)
          .attr('fill', 'rgba(0, 0, 0, 0.7)')
          .attr('rx', 5);
        
        tooltip.append('text')
          .attr('x', 40)
          .attr('y', 20)
          .attr('text-anchor', 'middle')
          .attr('fill', 'white')
          .attr('font-size', '12px');
        
        // Set up slider
        const slider = document.getElementById('time-slider');
        const sliderProgress = document.getElementById('slider-progress');
        const progressLabel = document.getElementById('progress-label');
        const timeLabel = document.getElementById('time-label');
        const hrValue = document.getElementById('hr-value');
        
        // Reset slider to beginning
        slider.value = 0;
        sliderProgress.style.width = '0%';
        
        // Function to update display based on slider position
        function updateDisplay(sliderValue) {
          const percent = sliderValue / 100;
          const currentTime = percent * examDuration;
          
          // Update slider progress bar
          sliderProgress.style.width = `${sliderValue}%`;
          
          // Update progress and time labels
          progressLabel.textContent = `${sliderValue}% through the exam`;
          timeLabel.textContent = formatTime(currentTime);
          
          // Find the closest data point to the current time
          const closestPoint = heartRateData.reduce((prev, curr) => {
            return Math.abs(curr.time - currentTime) < Math.abs(prev.time - currentTime) ? curr : prev;
          });
          
          // Update heart rate display
          hrValue.textContent = Math.round(closestPoint.heartRate);
          hrValue.style.color = getHeartRateColor(closestPoint.heartRate);
          
          // Update vertical line position
          timeIndicator
            .attr('x1', x(currentTime))
            .attr('x2', x(currentTime))
            .style('opacity', 1);
          
          // Update dot indicator
          dotIndicator
            .attr('cx', x(closestPoint.time))
            .attr('cy', y(closestPoint.heartRate))
            .attr('fill', getHeartRateColor(closestPoint.heartRate))
            .style('opacity', 1);
          
          // Update tooltip
          tooltip
            .attr('transform', `translate(${x(closestPoint.time) - 40}, ${y(closestPoint.heartRate) - 40})`)
            .style('opacity', 1);
          
          tooltip.select('text')
            .text(`${Math.round(closestPoint.heartRate)} bpm`);
        }
        
        // Initialize with current slider value
        updateDisplay(slider.value);
        
        // Add event listener for slider
        slider.addEventListener('input', function() {
          updateDisplay(this.value);
        });
      }
      
      // Format time as HH:MM:SS
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      
      // Get heart rate zone
      function getHeartRateZone(rate) {
        if (rate < config.heartRateZones.low.max) return 'low';
        if (rate < config.heartRateZones.resting.max) return 'resting';
        if (rate < config.heartRateZones.moderate.max) return 'moderate';
        return 'high';
      }
      
      // Get color for heart rate
      function getHeartRateColor(rate) {
        return config.heartRateZones[getHeartRateZone(rate)].color;
      }
      
      // Initialize with default student and exam
      initVisualization(config.studentId, config.examType);
      
      // Add event listener for student dropdown
      document.getElementById('student-dropdown').addEventListener('change', function() {
        const selectedStudentId = parseInt(this.value);
        const selectedExamType = document.getElementById('exam-dropdown').value;
        initVisualization(selectedStudentId, selectedExamType);
        
        // Update URL parameter without refreshing the page
        const url = new URL(window.location);
        url.searchParams.set('student', selectedStudentId);
        window.history.pushState({}, '', url);
      });
      
      // Add event listener for exam dropdown
      document.getElementById('exam-dropdown').addEventListener('change', function() {
        const selectedStudentId = parseInt(document.getElementById('student-dropdown').value);
        const selectedExamType = this.value;
        initVisualization(selectedStudentId, selectedExamType);
        
        // Update URL parameter without refreshing the page
        const url = new URL(window.location);
        url.searchParams.set('exam', selectedExamType);
        window.history.pushState({}, '', url);
      });
      
      // Handle window resize
      window.addEventListener('resize', function() {
        const selectedStudentId = parseInt(document.getElementById('student-dropdown').value);
        const selectedExamType = document.getElementById('exam-dropdown').value;
        initVisualization(selectedStudentId, selectedExamType);
      });
    });
  </script>
</body>
</html>
